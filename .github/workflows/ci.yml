name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Build Native AOT binaries on each platform
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Publish TestHost (linux-x64)
        run: dotnet publish tests/MinRT.TestHost -c Release -r linux-x64 -o artifacts/testhost-linux-x64

      - name: Publish hello app
        run: dotnet publish tests/apps/hello -c Release -o artifacts/hello

      - name: Publish hello-web app
        run: dotnet publish tests/apps/hello-web -c Release -o artifacts/hello-web

      - name: Create pre-built runtime layout (for airgap test)
        run: |
          # Create a runtime layout that can be used offline
          ./artifacts/testhost-linux-x64/MinRT.TestHost --create-layout artifacts/runtime-layout --aspnet
          ls -la artifacts/runtime-layout/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: artifacts/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Publish TestHost (win-x64)
        run: dotnet publish tests/MinRT.TestHost -c Release -r win-x64 -o artifacts/testhost-win-x64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: artifacts/

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Publish TestHost (osx-arm64)
        run: dotnet publish tests/MinRT.TestHost -c Release -r osx-arm64 -o artifacts/testhost-osx-arm64

      - name: Create pre-built runtime layout (for airgap test)
        run: |
          # Create a runtime layout that can be used offline
          chmod +x ./artifacts/testhost-osx-arm64/MinRT.TestHost
          ./artifacts/testhost-osx-arm64/MinRT.TestHost --create-layout artifacts/runtime-layout-osx --aspnet
          ls -la artifacts/runtime-layout-osx/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/

  # Core E2E on Linux (NO .NET installed)
  core-e2e-linux:
    runs-on: ubuntu-latest
    needs: build-linux
    # Use a minimal container WITHOUT .NET pre-installed
    container: ubuntu:22.04
    steps:
      - name: Install minimal dependencies
        run: |
          apt-get update
          apt-get install -y curl libicu70
          echo "✓ Minimal container ready"

      - name: Check .NET status
        run: |
          # GitHub Actions may inject some tooling, but the ubuntu:22.04 container
          # doesn't have the .NET SDK installed in standard locations
          if [ -d "/usr/share/dotnet" ]; then
            echo "✗ /usr/share/dotnet exists - unexpected"
          else
            echo "✓ No system .NET SDK at /usr/share/dotnet"
          fi
          # Show what dotnet might be found (Actions may inject node tooling)
          which dotnet 2>/dev/null || echo "✓ No dotnet in PATH"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: artifacts/

      - name: Make TestHost executable
        run: chmod +x artifacts/testhost-linux-x64/MinRT.TestHost

      - name: Run hello app via MinRT
        run: |
          cd artifacts
          ./testhost-linux-x64/MinRT.TestHost hello/hello.dll
        timeout-minutes: 5

      - name: Run hello-web app via MinRT
        run: |
          cd artifacts
          # Start web app in background (--aspnet enables ASP.NET Core framework)
          ./testhost-linux-x64/MinRT.TestHost hello-web/hello-web.dll --aspnet &
          APP_PID=$!
          
          # Wait for startup
          echo "Waiting for app to start..."
          sleep 10
          
          # Test the endpoint
          echo "Testing http://localhost:5099..."
          RESPONSE=$(curl -s --retry 5 --retry-delay 2 http://localhost:5099 || echo "CURL_FAILED")
          echo "Response: $RESPONSE"
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          
          # Verify response (POSIX-compatible)
          if echo "$RESPONSE" | grep -q "Hello from ASP.NET Core"; then
            echo "✓ ASP.NET Core app working!"
          else
            echo "✗ Unexpected response"
            exit 1
          fi
        timeout-minutes: 5

  # Airgap/Offline E2E on Linux (NO .NET, NO NuGet access)
  airgap-e2e-linux:
    runs-on: ubuntu-latest
    needs: build-linux
    # Use a minimal container WITHOUT .NET pre-installed
    container: ubuntu:22.04
    steps:
      - name: Install minimal dependencies
        run: |
          apt-get update
          apt-get install -y curl libicu70
          echo "✓ Minimal container ready"

      - name: Check .NET status
        run: |
          # GitHub Actions may inject some tooling, but the ubuntu:22.04 container
          # doesn't have the .NET SDK installed in standard locations
          if [ -d "/usr/share/dotnet" ]; then
            echo "✗ /usr/share/dotnet exists - unexpected"
          else
            echo "✓ No system .NET SDK at /usr/share/dotnet"
          fi
          # Show what dotnet might be found (Actions may inject node tooling)
          which dotnet 2>/dev/null || echo "✓ No dotnet in PATH"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: artifacts/

      - name: Make TestHost executable
        run: chmod +x artifacts/testhost-linux-x64/MinRT.TestHost

      - name: Show runtime layout contents
        run: |
          echo "Pre-built runtime layout:"
          ls -la artifacts/runtime-layout/
          echo ""
          echo "Shared frameworks:"
          ls -la artifacts/runtime-layout/shared/

      - name: Run hello app via MinRT (offline with pre-built layout)
        run: |
          cd artifacts
          echo "Using --offline flag - any download attempt will fail"
          ./testhost-linux-x64/MinRT.TestHost hello/hello.dll --layout runtime-layout --offline
        timeout-minutes: 2

      - name: Run hello-web app via MinRT (offline with pre-built layout)
        run: |
          cd artifacts
          echo "Using --offline flag - any download attempt will fail"
          # Start web app in background using pre-built layout
          ./testhost-linux-x64/MinRT.TestHost hello-web/hello-web.dll --aspnet --layout runtime-layout --offline &
          APP_PID=$!
          
          # Wait for startup
          echo "Waiting for app to start..."
          sleep 10
          
          # Test the endpoint
          echo "Testing http://localhost:5099..."
          RESPONSE=$(curl -s --retry 5 --retry-delay 2 http://localhost:5099 || echo "CURL_FAILED")
          echo "Response: $RESPONSE"
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          
          # Verify response (POSIX-compatible)
          if echo "$RESPONSE" | grep -q "Hello from ASP.NET Core"; then
            echo "✓ ASP.NET Core app working in airgap mode!"
          else
            echo "✗ Unexpected response"
            exit 1
          fi
        timeout-minutes: 5

  # Airgap/Offline E2E on macOS (NO .NET, NO NuGet access)
  airgap-e2e-macos:
    runs-on: macos-latest
    needs: [build-macos, build-linux]
    # Intentionally NO setup-dotnet - proves MinRT works without pre-installed .NET
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/

      - name: Download Linux artifacts (for test apps)
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: linux-artifacts/

      - name: Copy test apps
        run: |
          cp -r linux-artifacts/hello artifacts/hello
          cp -r linux-artifacts/hello-web artifacts/hello-web

      - name: Make TestHost executable
        run: chmod +x artifacts/testhost-osx-arm64/MinRT.TestHost

      - name: Show runtime layout contents
        run: |
          echo "Pre-built runtime layout:"
          ls -la artifacts/runtime-layout-osx/
          echo ""
          echo "Shared frameworks:"
          ls -la artifacts/runtime-layout-osx/shared/

      - name: Run hello app via MinRT (offline with pre-built layout)
        run: |
          cd artifacts
          echo "Using --offline flag - any download attempt will fail"
          ./testhost-osx-arm64/MinRT.TestHost hello/hello.dll --layout runtime-layout-osx --offline
        timeout-minutes: 2

      - name: Run hello-web app via MinRT (offline with pre-built layout)
        run: |
          cd artifacts
          echo "Using --offline flag - any download attempt will fail"
          # Start web app in background using pre-built layout
          ./testhost-osx-arm64/MinRT.TestHost hello-web/hello-web.dll --aspnet --layout runtime-layout-osx --offline &
          APP_PID=$!
          
          # Wait for startup
          echo "Waiting for app to start..."
          sleep 10
          
          # Test the endpoint
          echo "Testing http://localhost:5099..."
          RESPONSE=$(curl -s --retry 5 --retry-delay 2 http://localhost:5099 || echo "CURL_FAILED")
          echo "Response: $RESPONSE"
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          
          # Verify response
          if [[ "$RESPONSE" == *"Hello from ASP.NET Core"* ]]; then
            echo "✓ ASP.NET Core app working in airgap mode on macOS!"
          else
            echo "✗ Unexpected response"
            exit 1
          fi
        timeout-minutes: 5

  # Core E2E on Windows (NO .NET installed)
  core-e2e-windows:
    runs-on: windows-latest
    needs: [build-windows, build-linux]
    # Intentionally NO setup-dotnet
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: artifacts/

      - name: Download Linux artifacts (for test apps)
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: linux-artifacts/

      - name: Copy test apps
        shell: pwsh
        run: |
          Copy-Item -Path linux-artifacts/hello -Destination artifacts/hello -Recurse
          Copy-Item -Path linux-artifacts/hello-web -Destination artifacts/hello-web -Recurse

      - name: Remove system .NET (prove MinRT works without it)
        shell: pwsh
        run: |
          Write-Host "Removing system .NET to prove MinRT works independently..."
          # Remove .NET from common locations
          if (Test-Path "C:\Program Files\dotnet") {
            Remove-Item -Path "C:\Program Files\dotnet" -Recurse -Force -ErrorAction SilentlyContinue
          }
          if (Test-Path "$env:USERPROFILE\.dotnet") {
            Remove-Item -Path "$env:USERPROFILE\.dotnet" -Recurse -Force -ErrorAction SilentlyContinue
          }
          # Remove from PATH for this session
          $env:PATH = ($env:PATH -split ';' | Where-Object { $_ -notlike '*dotnet*' }) -join ';'
          
          $dotnetPath = Get-Command dotnet -ErrorAction SilentlyContinue
          if ($dotnetPath) {
            Write-Host "WARNING: dotnet still found after removal attempt"
          } else {
            Write-Host "✓ System .NET removed successfully"
          }

      - name: Run hello app via MinRT
        shell: pwsh
        run: |
          cd artifacts
          .\testhost-win-x64\MinRT.TestHost.exe hello\hello.dll
        timeout-minutes: 5

      - name: Run hello-web app via MinRT
        shell: pwsh
        run: |
          cd artifacts
          
          # Start web app in background (--aspnet enables ASP.NET Core framework)
          $process = Start-Process -FilePath ".\testhost-win-x64\MinRT.TestHost.exe" `
            -ArgumentList "hello-web\hello-web.dll", "--aspnet" `
            -PassThru -NoNewWindow
          
          # Wait for startup
          Write-Host "Waiting for app to start..."
          Start-Sleep -Seconds 15
          
          # Test the endpoint
          Write-Host "Testing http://localhost:5099..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:5099" -UseBasicParsing -TimeoutSec 30
            Write-Host "Response: $($response.Content)"
            
            if ($response.Content -like "*Hello from ASP.NET Core*") {
              Write-Host "✓ ASP.NET Core app working!"
            } else {
              Write-Host "✗ Unexpected response"
              exit 1
            }
          } catch {
            Write-Host "✗ Request failed: $_"
            exit 1
          } finally {
            # Kill the app
            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          }
        timeout-minutes: 5

  # Core E2E on macOS (NO .NET installed)
  core-e2e-macos:
    runs-on: macos-latest
    needs: [build-macos, build-linux]
    # Intentionally NO setup-dotnet
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/

      - name: Download Linux artifacts (for test apps)
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: linux-artifacts/

      - name: Copy test apps
        run: |
          cp -r linux-artifacts/hello artifacts/hello
          cp -r linux-artifacts/hello-web artifacts/hello-web

      - name: Make TestHost executable
        run: chmod +x artifacts/testhost-osx-arm64/MinRT.TestHost

      - name: Remove system .NET (prove MinRT works without it)
        run: |
          echo "Removing system .NET to prove MinRT works independently..."
          sudo rm -rf /usr/local/share/dotnet
          sudo rm -rf ~/.dotnet
          hash -r
          if command -v dotnet &> /dev/null; then
            echo "WARNING: dotnet still found after removal attempt"
          else
            echo "✓ System .NET removed successfully"
          fi

      - name: Run hello app via MinRT
        run: |
          cd artifacts
          ./testhost-osx-arm64/MinRT.TestHost hello/hello.dll
        timeout-minutes: 5

      - name: Run hello-web app via MinRT
        run: |
          cd artifacts
          # Start web app in background (--aspnet enables ASP.NET Core framework)
          ./testhost-osx-arm64/MinRT.TestHost hello-web/hello-web.dll --aspnet &
          APP_PID=$!
          
          # Wait for startup
          echo "Waiting for app to start..."
          sleep 10
          
          # Test the endpoint
          echo "Testing http://localhost:5099..."
          RESPONSE=$(curl -s --retry 5 --retry-delay 2 http://localhost:5099 || echo "CURL_FAILED")
          echo "Response: $RESPONSE"
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          
          # Verify response
          if [[ "$RESPONSE" == *"Hello from ASP.NET Core"* ]]; then
            echo "✓ ASP.NET Core app working!"
          else
            echo "✗ Unexpected response"
            exit 1
          fi
        timeout-minutes: 5

  # NuGet Assembly Loader tests (xUnit)
  nuget-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Restore
        run: dotnet restore MinRT.slnx

      - name: Run NuGet tests
        run: dotnet test tests/MinRT.Tests --verbosity normal
        timeout-minutes: 10
